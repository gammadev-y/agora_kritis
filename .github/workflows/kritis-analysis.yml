name: 🧠 Kritis Analysis - AI Legal Document Analysis (V5.0 Recommended)

on:
  workflow_dispatch:
    inputs:
      source_id:
        description: 'Source ID to analyze (UUID format)'
        required: true
        type: string
      job_id:
        description: 'Background Job ID for status tracking (optional, UUID format)'
        required: false
        type: string
      pipeline_stage:
        description: 'Pipeline stage to run'
        required: true
        default: 'v50-complete'
        type: choice
        options:
          - 'v50-complete'
          - 'v50-extract'
          - 'v50-analyze'
          - 'v50-build-graph'
          - 'v40-complete'
          - 'v40-extract'
          - 'v40-analyze'
          - 'v40-synthesize'
          - 'v40-ingest'
          - 'validate-environment'

jobs:
  kritis-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: 📚 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python 3.13
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        cache: 'pip'
        
    - name: 📦 Install Dependencies
      run: |
        cd agora-analyst-python
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 🔧 Configure Environment
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        cd agora-analyst-python
        echo "SUPABASE_URL=$SUPABASE_URL" >> .env
        echo "SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY" >> .env
        echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> .env
        echo "GEMINI_API_KEY=$GEMINI_API_KEY" >> .env
        
    - name: ✅ Validate Source ID
      run: |
        python -c "
        import uuid, sys
        try:
            uuid.UUID('${{ github.event.inputs.source_id }}')
            print('✅ Valid UUID format')
        except ValueError:
            print('❌ Invalid UUID format')
            sys.exit(1)
        "
        
    - name: 🧠 Run Kritis Analysis Pipeline
      run: |
        set -e  # Exit on any error
        cd agora-analyst-python
        
        SOURCE_ID="${{ github.event.inputs.source_id }}"
        JOB_ID="${{ github.event.inputs.job_id }}"
        PIPELINE_STAGE="${{ github.event.inputs.pipeline_stage }}"
        
        # Build command with optional job_id
        CMD_ARGS="--source-id $SOURCE_ID"
        if [ -n "$JOB_ID" ]; then
          CMD_ARGS="$CMD_ARGS --job-id $JOB_ID"
          echo "📌 Background Job ID: $JOB_ID"
        fi
        
        echo "🚀 Starting Kritis Analysis for Source: $SOURCE_ID"
        echo "📋 Pipeline Stage: $PIPELINE_STAGE"
        
        # Validate environment first
        echo "🔧 Validating production environment..."
        python validate_production.py
        
        if [ "$PIPELINE_STAGE" = "v50-complete" ]; then
          echo "🔄 Running Complete Kritis V5.0 Pipeline (RECOMMENDED)"
          echo "   - Stage 1: Enhanced Extraction with HTML preservation"
          echo "   - Stage 2: Enhanced Analysis with cross-reference extraction"
          echo "   - Stage 3: Knowledge Graph Builder with relationship processing"
          echo ""
          echo "✨ V5.0 Features:"
          echo "   - URL-based reference matching (priority 1)"
          echo "   - Law-to-law relationships"
          echo "   - Article-to-article relationships"
          echo "   - Preamble cross-reference processing"
          echo "   - Temporal consistency validation"
          echo "   - Automatic status updates (superseded/revoked)"
          
          python main.py $CMD_ARGS v50-complete
          echo "✅ Complete V5.0 pipeline finished successfully!"
          
        elif [ "$PIPELINE_STAGE" = "v40-complete" ]; then
          echo "🔄 Running Complete Kritis V4.0 PROD10 Pipeline"
          echo "   - Stage 1: Enhanced Extraction with preamble awareness"
          echo "   - Stage 2: Definitive Analysis with V4.2 prompts"
          echo "   - Stage 3: Final Summary Synthesis with category suggestions"
          echo "   - Stage 4: Definitive Law Ingestion with date intelligence"
          
          python main.py $CMD_ARGS v40-complete
          echo "✅ Complete V4.0 PROD10 pipeline finished successfully!"
          
        elif [ "$PIPELINE_STAGE" = "validate-environment" ]; then
          echo "🔧 Running Environment Validation Only"
          python validate_production.py
          echo "✅ Environment validation completed!"
          
        else
          echo "🔄 Running Single Stage: $PIPELINE_STAGE"
          python main.py $CMD_ARGS "$PIPELINE_STAGE"
          echo "✅ Stage completed successfully!"
        fi
        
    - name: 📊 Generate Analysis Report
      if: always()
      run: |
        PIPELINE_STAGE="${{ github.event.inputs.pipeline_stage }}"
        
        echo "## 📊 Kritis Analysis Report" >> $GITHUB_STEP_SUMMARY
        echo "- **Source ID**: ${{ github.event.inputs.source_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Pipeline Stage**: $PIPELINE_STAGE" >> $GITHUB_STEP_SUMMARY
        echo "- **Execution Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        
        # Determine version and features based on pipeline stage
        if [[ "$PIPELINE_STAGE" == v50* ]]; then
          echo "- **Version**: Kritis V5.0 Enhanced Relationships (RECOMMENDED)" >> $GITHUB_STEP_SUMMARY
          echo "- **Features**: URL-based matching, Law-to-law relationships, Article-to-article relationships, Preamble processing, Temporal validation" >> $GITHUB_STEP_SUMMARY
        elif [[ "$PIPELINE_STAGE" == v40* ]]; then
          echo "- **Version**: Kritis V4.0 Final Definitive (PROD10)" >> $GITHUB_STEP_SUMMARY
          echo "- **Features**: Date Intelligence, V4.2 Prompts, Category Suggestions" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "✅ **Result**: Analysis completed successfully" >> $GITHUB_STEP_SUMMARY
          if [[ "$PIPELINE_STAGE" == v50* ]]; then
            echo "🔗 **Quality**: Enhanced relationship processing with URL-based matching" >> $GITHUB_STEP_SUMMARY
            echo "📊 **Innovation**: Knowledge graph with law-to-law and article-to-article relationships" >> $GITHUB_STEP_SUMMARY
          else
            echo "🎯 **Quality**: Enhanced AI persona with structured tag categories" >> $GITHUB_STEP_SUMMARY
            echo "📅 **Innovation**: Intelligent article date extraction and validation" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "❌ **Result**: Analysis failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          echo "🔧 **Troubleshooting**: Verify environment secrets and source ID format" >> $GITHUB_STEP_SUMMARY
        fi